{"version":3,"file":"writing_practice.min.js","sources":["../src/writing_practice.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for Writing Practice: polling and grammar highlighting.\n *\n * @module     local_savian_ai/writing_practice\n * @copyright  2026 Savian AI\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n\n    /**\n     * @constructor\n     */\n    var WritingPractice = function() {\n        /** @type {object} Module configuration. */\n        this.config = {};\n        /** @type {number|null} Polling timer handle. */\n        this.pollTimer = null;\n        /** @type {boolean} Whether polling is active. */\n        this.polling = false;\n        /** @type {number} Timestamp (ms) when polling started. */\n        this.startTime = 0;\n        /** @type {number} Maximum polling duration in ms (5 minutes). */\n        this.maxElapsed = 300000;\n        /** @type {number[]} Backoff intervals in ms — ramps up to 10 s then holds. */\n        this.intervals = [3000, 5000, 5000, 8000, 10000, 10000, 10000];\n        /** @type {number} Current interval index. */\n        this.intervalIndex = 0;\n        /** @type {number} Consecutive AJAX error count. */\n        this.errorCount = 0;\n        /** @type {number} Max consecutive errors before giving up. */\n        this.maxErrors = 5;\n    };\n\n    /**\n     * Initialise the module.\n     *\n     * @param {object} cfg Configuration: {mode, submissionuuid, courseid, feedbackurl}.\n     * @return {void}\n     */\n    WritingPractice.prototype.init = function(cfg) {\n        this.config = cfg;\n        if (cfg.mode === 'poll') {\n            this.startTime = Date.now();\n            this.polling = true;\n            this.scheduleNext();\n        } else if (cfg.mode === 'feedback') {\n            this.initGrammarHighlighting();\n        }\n    };\n\n    /**\n     * Schedule the next poll, respecting the timeout.\n     *\n     * @return {void}\n     */\n    WritingPractice.prototype.scheduleNext = function() {\n        if (!this.polling) {\n            return;\n        }\n\n        var elapsed = Date.now() - this.startTime;\n        if (elapsed >= this.maxElapsed) {\n            this.stopPolling();\n            var timeoutMsg = $('#savian-wp-timeout-msg').text();\n            Notification.addNotification({message: timeoutMsg || 'Assessment timed out.', type: 'error'});\n            return;\n        }\n\n        var idx = Math.min(this.intervalIndex, this.intervals.length - 1);\n        var delay = this.intervals[idx];\n        this.intervalIndex++;\n\n        var self = this;\n        this.pollTimer = setTimeout(function() {\n            self.doPoll();\n        }, delay);\n    };\n\n    /**\n     * Perform a single AJAX poll.\n     *\n     * On transient error: increments errorCount and retries up to maxErrors times.\n     * On terminal status (completed/failed): stops polling.\n     *\n     * @return {void}\n     */\n    WritingPractice.prototype.doPoll = function() {\n        var self = this;\n\n        Ajax.call([{\n            methodname: 'local_savian_ai_get_submission_status',\n            args: {\n                submissionuuid: self.config.submissionuuid,\n                courseid: self.config.courseid\n            }\n        }])[0].then(function(result) {\n            // Reset error counter on success.\n            self.errorCount = 0;\n\n            self.updateProgress(result.progress, result.stage);\n\n            if (result.status === 'completed') {\n                self.stopPolling();\n                window.location.href = self.config.feedbackurl;\n                return result;\n            }\n\n            if (result.status === 'failed') {\n                self.stopPolling();\n                Notification.addNotification({\n                    message: result.stage || 'Assessment failed. Please try again.',\n                    type: 'error'\n                });\n                return result;\n            }\n\n            // Still pending/processing — schedule next poll.\n            self.scheduleNext();\n            return result;\n        }).catch(function() {\n            self.errorCount++;\n            if (self.errorCount >= self.maxErrors) {\n                self.stopPolling();\n                Notification.addNotification({\n                    message: 'Lost connection to server. Please refresh the page.',\n                    type: 'error'\n                });\n                return;\n            }\n            // Transient error — keep polling, show a subtle status update.\n            $('#savian-wp-stage-label').text('Checking... (' + self.errorCount + ' retries)');\n            self.scheduleNext();\n        });\n    };\n\n    /**\n     * Update the progress bar and stage label.\n     *\n     * @param {number} progress Progress value 0-100.\n     * @param {string} stage Human-readable stage description.\n     * @return {void}\n     */\n    WritingPractice.prototype.updateProgress = function(progress, stage) {\n        var bar = $('#savian-wp-progress-bar');\n        bar.css('width', progress + '%');\n        bar.attr('aria-valuenow', progress);\n        bar.text(progress + '%');\n\n        if (stage) {\n            $('#savian-wp-stage-label').text(stage);\n        }\n    };\n\n    /**\n     * Stop polling and clear the timer.\n     *\n     * @return {void}\n     */\n    WritingPractice.prototype.stopPolling = function() {\n        this.polling = false;\n        if (this.pollTimer !== null) {\n            clearTimeout(this.pollTimer);\n            this.pollTimer = null;\n        }\n    };\n\n    /**\n     * Annotate submission text with grammar error highlights using safe DOM methods.\n     *\n     * Reads errors JSON from #savian-wp-errors data attribute, builds a\n     * DocumentFragment with <mark> spans at the correct offsets, and replaces\n     * the text node — no innerHTML is used.\n     *\n     * @return {void}\n     */\n    WritingPractice.prototype.initGrammarHighlighting = function() {\n        var errorsEl = document.getElementById('savian-wp-errors');\n        var textEl = document.getElementById('savian-wp-submission-text');\n        if (!errorsEl || !textEl) {\n            return;\n        }\n\n        var errors;\n        try {\n            errors = JSON.parse(errorsEl.getAttribute('data-errors') || '[]');\n        } catch (e) {\n            return;\n        }\n\n        if (!errors.length) {\n            return;\n        }\n\n        var text = textEl.textContent || '';\n\n        // Sort errors by offset ascending.\n        errors = errors.slice().sort(function(a, b) {\n            return (a.offset || 0) - (b.offset || 0);\n        });\n\n        var fragment = document.createDocumentFragment();\n        var cursor = 0;\n\n        errors.forEach(function(err) {\n            var offset = parseInt(err.offset, 10) || 0;\n            var length = parseInt(err.length, 10) || 1;\n\n            // Text before this error.\n            if (offset > cursor) {\n                fragment.appendChild(document.createTextNode(text.slice(cursor, offset)));\n            }\n\n            // Build the <mark> using DOM to avoid XSS.\n            var mark = document.createElement('mark');\n            var cls = 'savian-wp-error-mark';\n            if ((err.type || '').toLowerCase() === 'spelling') {\n                cls += ' spelling';\n            }\n            mark.className = cls;\n            var replacements = (err.replacements || []).join(', ');\n            var tipText = (err.message || '') + (replacements ? ' \\u2192 ' + replacements : '');\n            mark.setAttribute('title', tipText);\n            mark.textContent = text.slice(offset, offset + length);\n            fragment.appendChild(mark);\n\n            cursor = offset + length;\n        });\n\n        // Any remaining text after the last error.\n        if (cursor < text.length) {\n            fragment.appendChild(document.createTextNode(text.slice(cursor)));\n        }\n\n        // Replace children with the annotated fragment.\n        while (textEl.firstChild) {\n            textEl.removeChild(textEl.firstChild);\n        }\n        textEl.appendChild(fragment);\n    };\n\n    return {\n        /**\n         * Module entry point called by PHP.\n         *\n         * @param {object} cfg Configuration object.\n         * @return {void}\n         */\n        init: function(cfg) {\n            var widget = new WritingPractice();\n            widget.init(cfg);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","WritingPractice","config","pollTimer","polling","startTime","maxElapsed","intervals","intervalIndex","errorCount","maxErrors","prototype","init","cfg","mode","Date","now","scheduleNext","initGrammarHighlighting","this","stopPolling","timeoutMsg","text","addNotification","message","type","idx","Math","min","length","delay","self","setTimeout","doPoll","call","methodname","args","submissionuuid","courseid","then","result","updateProgress","progress","stage","status","window","location","href","feedbackurl","catch","bar","css","attr","clearTimeout","errorsEl","document","getElementById","textEl","errors","JSON","parse","getAttribute","e","textContent","slice","sort","a","b","offset","fragment","createDocumentFragment","cursor","forEach","err","parseInt","appendChild","createTextNode","mark","createElement","cls","toLowerCase","className","replacements","join","tipText","setAttribute","firstChild","removeChild"],"mappings":"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"}