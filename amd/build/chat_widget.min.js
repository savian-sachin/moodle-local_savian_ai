/**
 * Savian AI Floating Chat Widget
 *
 * @module     local_savian_ai/chat_widget
 * @copyright  2025 Savian AI
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_savian_ai/chat_widget",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){var ChatWidget=function(){this.isMinimized=!0,this.isMaximized=!1,this.position="bottom-right",this.conversationId=null,this.courseId=null,this.config={},this.strings={}};return ChatWidget.prototype.init=function(config){this.config=config||{};var courseMatch=$("body").attr("class").match(/course-(\d+)/);courseMatch&&(this.courseId=parseInt(courseMatch[1]));var self=this;Str.get_strings([{key:"openchat",component:"local_savian_ai"},{key:"minimize",component:"local_savian_ai"},{key:"maximize",component:"local_savian_ai"},{key:"newconversation",component:"local_savian_ai"},{key:"history",component:"local_savian_ai"},{key:"typemessage",component:"local_savian_ai"},{key:"send",component:"local_savian_ai"},{key:"helpful",component:"local_savian_ai"},{key:"nothelpful",component:"local_savian_ai"}]).done((function(strings){(self.strings={openchat:strings[0],minimize:strings[1],maximize:strings[2],newconversation:strings[3],history:strings[4],typemessage:strings[5],send:strings[6],helpful:strings[7],nothelpful:strings[8]},self.loadUserSettings(),self.config.restriction&&self.config.restriction.isRestricted)?self.renderRestrictedState():(self.render(),self.attachEvents(),"1"===new URLSearchParams(window.location.search).get("openchat")&&self.maximize())}))},ChatWidget.prototype.loadUserSettings=function(){var settings=localStorage.getItem("savian_chat_widget_settings");settings?(settings=JSON.parse(settings),this.position=settings.position||this.config.defaultPosition||"bottom-right",this.isMinimized=void 0===settings.minimized||settings.minimized):(this.position=this.config.userPosition||this.config.defaultPosition||"bottom-right",this.isMinimized=void 0===this.config.userMinimized||this.config.userMinimized)},ChatWidget.prototype.render=function(){var positionClass="savian-widget-"+this.position,minimizedClass=this.isMinimized?"minimized":"maximized",welcomeMsg=this.config.welcomeMessage||"Hi! I'm your AI assistant. Ask me anything about your course materials.",html='\n            <div id="savian-chat-widget" class="savian-chat-widget '.concat(positionClass," ").concat(minimizedClass,'">\n                \x3c!-- Minimized bubble --\x3e\n                <div class="savian-chat-bubble" role="button" tabindex="0" aria-label="').concat(this.strings.openchat,'">\n                    <i class="fa fa-comments"></i>\n                    <span class="notification-badge hidden">0</span>\n                </div>\n\n                \x3c!-- Maximized chat window --\x3e\n                <div class="savian-chat-window" role="dialog" aria-label="Savian AI Chat">\n                    <div class="savian-chat-header">\n                        <div class="savian-chat-title">\n                            <i class="fa fa-graduation-cap"></i>\n                            <span>Savian AI Tutor</span>\n                        </div>\n                        <div class="savian-chat-actions">\n                            <button class="savian-btn-icon" id="savian-chat-new" title="').concat(this.strings.newconversation,'">\n                                <i class="fa fa-plus"></i>\n                            </button>\n                            ').concat(this.config.canViewHistory?'<button class="savian-btn-icon" id="savian-chat-history" title="'+this.strings.history+'"><i class="fa fa-history"></i></button>':"",'\n                            <button class="savian-btn-icon" id="savian-chat-fullscreen" title="').concat(this.strings.maximize,'">\n                                <i class="fa fa-expand"></i>\n                            </button>\n                            <button class="savian-btn-icon" id="savian-chat-minimize" title="').concat(this.strings.minimize,'">\n                                <i class="fa fa-minus"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    <div class="savian-chat-body">\n                        <div class="savian-chat-messages" id="savian-chat-messages">\n                            \x3c!-- Welcome message --\x3e\n                            <div class="savian-chat-message assistant">\n                                <div class="savian-message-content">').concat(welcomeMsg,'</div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Document selector - HIDDEN (auto-uses course documents) --\x3e\n                    </div>\n\n                    <div class="savian-chat-footer">\n                        <div class="savian-chat-input-wrapper">\n                            <textarea\n                                id="savian-chat-input"\n                                class="savian-chat-input"\n                                placeholder="').concat(this.strings.typemessage,'"\n                                rows="1"\n                                aria-label="Chat message input"\n                            ></textarea>\n                            <button id="savian-chat-send" class="savian-btn-send" aria-label="').concat(this.strings.send,'">\n                                <i class="fa fa-paper-plane"></i>\n                            </button>\n                        </div>\n                        <div class="savian-chat-status" id="savian-chat-status"></div>\n                    </div>\n                </div>\n            </div>\n        ');$("body").append(html),this.config.canManageDocuments&&this.courseId&&this.loadCourseDocuments()},ChatWidget.prototype.renderRestrictedState=function(){var restriction=this.config.restriction,resumesAt=restriction.resumesAt?1e3*restriction.resumesAt:0,positionClass="savian-widget-"+this.position,countdownHtml="";countdownHtml=resumesAt>0?'\n                <div class="restriction-countdown">\n                    <p class="countdown-label">Resumes in:</p>\n                    <div class="countdown-timer">\n                        <div class="countdown-unit">\n                            <span class="countdown-value" id="countdown-hours">--</span>\n                            <span class="countdown-text">hrs</span>\n                        </div>\n                        <div class="countdown-unit">\n                            <span class="countdown-value" id="countdown-minutes">--</span>\n                            <span class="countdown-text">min</span>\n                        </div>\n                        <div class="countdown-unit">\n                            <span class="countdown-value" id="countdown-seconds">--</span>\n                            <span class="countdown-text">sec</span>\n                        </div>\n                    </div>\n                </div>\n            ':'<p class="restriction-no-end">Check back later</p>';var html='\n            <div id="savian-chat-widget" class="savian-chat-widget '.concat(positionClass,' restricted">\n                \x3c!-- Restricted bubble with overlay --\x3e\n                <div class="savian-chat-bubble restricted" role="button" tabindex="0" aria-label="Chat unavailable">\n                    <i class="fa fa-comments"></i>\n                    <span class="restriction-icon-overlay"><i class="fa fa-ban"></i></span>\n                </div>\n\n                \x3c!-- Restricted message window --\x3e\n                <div class="savian-chat-window restricted-window" role="dialog" aria-label="Chat Restricted">\n                    <div class="savian-chat-header restricted-header">\n                        <div class="savian-chat-title">\n                            <i class="fa fa-clock-o"></i>\n                            <span>Chat Temporarily Unavailable</span>\n                        </div>\n                        <div class="savian-chat-actions">\n                            <button class="savian-btn-icon" id="savian-chat-minimize" title="Minimize">\n                                <i class="fa fa-minus"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    <div class="savian-chat-body restriction-body">\n                        <div class="restriction-icon-large">\n                            <i class="fa fa-graduation-cap fa-4x"></i>\n                        </div>\n                        <p class="restriction-message">').concat(restriction.message,"</p>\n                        ").concat(countdownHtml,"\n                    </div>\n                </div>\n            </div>\n        ");$("body").append(html),this.attachRestrictedEvents(),resumesAt>0&&this.startCountdown(resumesAt)},ChatWidget.prototype.attachRestrictedEvents=function(){$(document).on("click","#savian-chat-widget.restricted .savian-chat-bubble",(function(){$("#savian-chat-widget").toggleClass("minimized").toggleClass("maximized")})),$(document).on("click","#savian-chat-widget.restricted #savian-chat-minimize",(function(e){e.stopPropagation(),$("#savian-chat-widget").addClass("minimized").removeClass("maximized")}))},ChatWidget.prototype.startCountdown=function(targetTime){var updateCountdown=function(){var now=Date.now(),remaining=targetTime-now;if(remaining<=0)window.location.reload();else{var hours=Math.floor(remaining/36e5),minutes=Math.floor(remaining%36e5/6e4),seconds=Math.floor(remaining%6e4/1e3);$("#countdown-hours").text(hours.toString().padStart(2,"0")),$("#countdown-minutes").text(minutes.toString().padStart(2,"0")),$("#countdown-seconds").text(seconds.toString().padStart(2,"0"))}};updateCountdown(),setInterval(updateCountdown,1e3)},ChatWidget.prototype.renderDocumentSelector=function(){return'\n            <div class="savian-document-selector" id="savian-document-selector">\n                <label>\n                    <i class="fa fa-file-text"></i>\n                    Select documents for context\n                </label>\n                <select multiple class="form-control form-control-sm" id="savian-doc-select" size="3">\n                    <option value="">Loading...</option>\n                </select>\n            </div>\n        '},ChatWidget.prototype.loadCourseDocuments=function(){Ajax.call([{methodname:"local_savian_ai_get_course_documents",args:{courseid:this.courseId}}])[0].done((function(response){if(response.success&&response.documents&&response.documents.length>0){var html='<option value="">Select documents (optional)</option>';response.documents.forEach((function(doc){html+='<option value="'+doc.id+'">'+doc.title+"</option>"})),$("#savian-doc-select").html(html)}else $("#savian-doc-select").html('<option value="">No documents available</option>')})).fail((function(error){console.error("Failed to load documents:",error),$("#savian-doc-select").html('<option value="">Failed to load documents</option>')}))},ChatWidget.prototype.attachEvents=function(){var self=this;$(document).on("click","#savian-chat-widget .savian-chat-bubble",(function(){self.maximize()})),$(document).on("keydown","#savian-chat-widget .savian-chat-bubble",(function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),self.maximize())})),$(document).on("click","#savian-chat-minimize",(function(){self.minimize()})),$(document).on("click","#savian-chat-fullscreen",(function(){self.toggleFullscreen()})),$(document).on("keydown",(function(e){"Escape"===e.key&&self.isMaximized&&self.toggleFullscreen()})),$(document).on("click","#savian-chat-send",(function(){self.sendMessage()})),$(document).on("keydown","#savian-chat-input",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),self.sendMessage())})),$(document).on("input","#savian-chat-input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"})),$(document).on("click","#savian-chat-new",(function(){self.startNewConversation()})),$(document).on("click","#savian-chat-history",(function(){self.showHistory()})),$(document).on("click",".savian-btn-feedback",(function(){var $btn=$(this),messageid=$btn.closest(".savian-message-feedback").data("message-id"),feedback=parseInt($btn.data("feedback"));self.submitFeedback(messageid,feedback,$btn)}))},ChatWidget.prototype.maximize=function(){this.isMinimized=!1,$("#savian-chat-widget").removeClass("minimized").addClass("maximized"),$("#savian-chat-input").focus(),this.saveWidgetState(),this.conversationId&&this.loadConversation(this.conversationId)},ChatWidget.prototype.minimize=function(){this.isMinimized=!0,this.isMaximized=!1,$("#savian-chat-widget").removeClass("maximized fullscreen").addClass("minimized"),$("#savian-chat-backdrop").remove(),this.updateFullscreenButton(),this.saveWidgetState()},ChatWidget.prototype.toggleFullscreen=function(){this.isMaximized=!this.isMaximized,this.isMaximized?($("#savian-chat-widget").addClass("fullscreen"),$("#savian-chat-fullscreen i").removeClass("fa-expand").addClass("fa-compress"),$("#savian-chat-fullscreen").attr("title","Exit fullscreen"),0===$("#savian-chat-backdrop").length&&$("body").append('<div id="savian-chat-backdrop" class="savian-chat-backdrop"></div>'),$("#savian-chat-input").focus()):($("#savian-chat-widget").removeClass("fullscreen"),$("#savian-chat-fullscreen i").removeClass("fa-compress").addClass("fa-expand"),$("#savian-chat-fullscreen").attr("title",this.strings.maximize),$("#savian-chat-backdrop").remove()),this.scrollToBottom()},ChatWidget.prototype.updateFullscreenButton=function(){this.isMaximized?$("#savian-chat-fullscreen i").removeClass("fa-expand").addClass("fa-compress"):$("#savian-chat-fullscreen i").removeClass("fa-compress").addClass("fa-expand")},ChatWidget.prototype.sendMessage=function(){var message=$("#savian-chat-input").val().trim();if(message){$("#savian-chat-input, #savian-chat-send").prop("disabled",!0),this.addMessageToUI("user",message),$("#savian-chat-input").val("").css("height","auto"),this.showTypingIndicator();var self=this;Ajax.call([{methodname:"local_savian_ai_send_chat_message",args:{message:message,conversationid:this.conversationId||0,courseid:this.courseId||0,documentids:[]}}])[0].done((function(response){self.hideTypingIndicator(),response.success?(self.conversationId=response.data.conversation_id,self.addMessageToUI("assistant",response.data.assistant_message.formatted_content,{sources:response.data.assistant_message.sources,messageId:response.data.assistant_message.id})):Notification.addNotification({message:response.error||"Failed to send message",type:"error"}),$("#savian-chat-input, #savian-chat-send").prop("disabled",!1),$("#savian-chat-input").focus()})).fail((function(error){self.hideTypingIndicator(),Notification.exception(error),$("#savian-chat-input, #savian-chat-send").prop("disabled",!1)}))}},ChatWidget.prototype.addMessageToUI=function(role,content,options){var sources=(options=options||{}).sources;if("string"==typeof sources)try{sources=JSON.parse(sources)}catch(e){sources=[]}var messageHtml='\n            <div class="savian-chat-message '.concat(role,'" data-message-id="').concat(options.messageId||"",'">\n                <div class="savian-message-content">\n                    ').concat(content,"\n                </div>\n                ").concat(sources&&sources.length>0?this.renderSources(sources):"","\n                ").concat("assistant"===role&&options.messageId&&this.config.enableFeedback?this.renderFeedback(options.messageId):"",'\n                <div class="savian-message-time">').concat(this.formatTime(new Date),"</div>\n            </div>\n        ");$("#savian-chat-messages").append(messageHtml),this.enhanceMessage($("#savian-chat-messages .savian-chat-message").last()),this.scrollToBottom()},ChatWidget.prototype.renderSources=function(sources){if(!sources||!Array.isArray(sources)||0===sources.length)return"";var sourcesHtml='<div class="savian-message-sources"><i class="fa fa-book"></i> Sources: ';return sources.forEach((function(source,idx){var title="";title="object"==typeof source&&null!==source?source.title||source.document_title||"Document "+(idx+1):"string"==typeof source?source:"Document "+(idx+1),sourcesHtml+='<span class="savian-source-badge">'.concat(title,"</span>")})),sourcesHtml+="</div>"},ChatWidget.prototype.renderFeedback=function(messageId){return'\n            <div class="savian-message-feedback" data-message-id="'.concat(messageId,'">\n                <button class="savian-btn-feedback" data-feedback="1" aria-label="').concat(this.strings.helpful,'">\n                    <i class="fa fa-thumbs-up"></i>\n                </button>\n                <button class="savian-btn-feedback" data-feedback="-1" aria-label="').concat(this.strings.nothelpful,'">\n                    <i class="fa fa-thumbs-down"></i>\n                </button>\n            </div>\n        ')},ChatWidget.prototype.enhanceMessage=function($messageEl){$messageEl.find("pre code").each((function(){window.hljs&&window.hljs.highlightElement(this)})),window.MathJax&&window.MathJax.typesetPromise&&MathJax.typesetPromise([$messageEl[0]]).catch((function(err){console.error("MathJax rendering error:",err)}))},ChatWidget.prototype.showTypingIndicator=function(){$("#savian-chat-messages").append('\n            <div class="savian-chat-message assistant savian-typing-indicator" id="savian-typing-indicator">\n                <div class="savian-message-content">\n                    <span class="savian-typing-dot"></span>\n                    <span class="savian-typing-dot"></span>\n                    <span class="savian-typing-dot"></span>\n                </div>\n            </div>\n        '),this.scrollToBottom()},ChatWidget.prototype.hideTypingIndicator=function(){$("#savian-typing-indicator").remove()},ChatWidget.prototype.scrollToBottom=function(){var $messages=$("#savian-chat-messages");$messages.scrollTop($messages[0].scrollHeight)},ChatWidget.prototype.loadConversation=function(conversationId){var self=this;Ajax.call([{methodname:"local_savian_ai_get_conversation",args:{conversationid:conversationId}}])[0].done((function(response){response.success&&response.data.messages&&($("#savian-chat-messages").empty(),response.data.messages.forEach((function(msg){self.addMessageToUI(msg.role,msg.formatted_content,{sources:msg.sources,messageId:msg.id})})))})).fail((function(error){console.error("Failed to load conversation:",error)}))},ChatWidget.prototype.startNewConversation=function(){this.conversationId=null,$("#savian-chat-messages").empty();var welcomeMsg=this.config.welcomeMessage||"Hi! I'm your AI assistant. Ask me anything about your course materials.";this.addMessageToUI("assistant",welcomeMsg)},ChatWidget.prototype.showHistory=function(){if(this.config.canViewHistory&&this.courseId){var url=M.cfg.wwwroot+"/local/savian_ai/chat_history.php?courseid="+this.courseId;window.open(url,"_blank")}},ChatWidget.prototype.submitFeedback=function(messageId,feedback,$btn){Ajax.call([{methodname:"local_savian_ai_submit_feedback",args:{messageid:messageId,feedback:feedback,comment:""}}])[0].done((function(response){response.success&&$btn.addClass("active").siblings().removeClass("active")})).fail((function(error){console.error("Failed to submit feedback:",error)}))},ChatWidget.prototype.saveWidgetState=function(){var settings={position:this.position,minimized:this.isMinimized};localStorage.setItem("savian_chat_widget_settings",JSON.stringify(settings)),Ajax.call([{methodname:"local_savian_ai_save_widget_state",args:{position:this.position,minimized:this.isMinimized?1:0}}])[0].fail((function(error){console.error("Failed to save widget state:",error)}))},ChatWidget.prototype.formatTime=function(date){return date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},{init:function(config){(new ChatWidget).init(config)}}}));

//# sourceMappingURL=chat_widget.min.js.map