/**
 * AMD module for Writing Practice: polling and grammar highlighting.
 *
 * @module     local_savian_ai/writing_practice
 * @copyright  2026 Savian AI
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_savian_ai/writing_practice",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){var WritingPractice=function(){this.config={},this.pollTimer=null,this.polling=!1,this.startTime=0,this.maxElapsed=3e5,this.intervals=[3e3,5e3,5e3,8e3,1e4,1e4,1e4],this.intervalIndex=0,this.errorCount=0,this.maxErrors=5};return WritingPractice.prototype.init=function(cfg){this.config=cfg,"poll"===cfg.mode?(this.startTime=Date.now(),this.polling=!0,this.scheduleNext()):"feedback"===cfg.mode&&this.initGrammarHighlighting()},WritingPractice.prototype.scheduleNext=function(){if(this.polling)if(Date.now()-this.startTime>=this.maxElapsed){this.stopPolling();var timeoutMsg=$("#savian-wp-timeout-msg").text();Notification.addNotification({message:timeoutMsg||"Assessment timed out.",type:"error"})}else{var idx=Math.min(this.intervalIndex,this.intervals.length-1),delay=this.intervals[idx];this.intervalIndex++;var self=this;this.pollTimer=setTimeout((function(){self.doPoll()}),delay)}},WritingPractice.prototype.doPoll=function(){var self=this;Ajax.call([{methodname:"local_savian_ai_get_submission_status",args:{submissionuuid:self.config.submissionuuid,courseid:self.config.courseid}}])[0].then((function(result){return self.errorCount=0,self.updateProgress(result.progress,result.stage),"completed"===result.status?(self.stopPolling(),window.location.href=self.config.feedbackurl,result):"failed"===result.status?(self.stopPolling(),Notification.addNotification({message:result.stage||"Assessment failed. Please try again.",type:"error"}),result):(self.scheduleNext(),result)})).catch((function(){if(self.errorCount++,self.errorCount>=self.maxErrors)return self.stopPolling(),void Notification.addNotification({message:"Lost connection to server. Please refresh the page.",type:"error"});$("#savian-wp-stage-label").text("Checking... ("+self.errorCount+" retries)"),self.scheduleNext()}))},WritingPractice.prototype.updateProgress=function(progress,stage){var bar=$("#savian-wp-progress-bar");bar.css("width",progress+"%"),bar.attr("aria-valuenow",progress),bar.text(progress+"%"),stage&&$("#savian-wp-stage-label").text(stage)},WritingPractice.prototype.stopPolling=function(){this.polling=!1,null!==this.pollTimer&&(clearTimeout(this.pollTimer),this.pollTimer=null)},WritingPractice.prototype.initGrammarHighlighting=function(){var errorsEl=document.getElementById("savian-wp-errors"),textEl=document.getElementById("savian-wp-submission-text");if(errorsEl&&textEl){var errors;try{errors=JSON.parse(errorsEl.getAttribute("data-errors")||"[]")}catch(e){return}if(errors.length){var text=textEl.textContent||"";errors=errors.slice().sort((function(a,b){return(a.offset||0)-(b.offset||0)}));var fragment=document.createDocumentFragment(),cursor=0;for(errors.forEach((function(err){var offset=parseInt(err.offset,10)||0,length=parseInt(err.length,10)||1;offset>cursor&&fragment.appendChild(document.createTextNode(text.slice(cursor,offset)));var mark=document.createElement("mark"),cls="savian-wp-error-mark";"spelling"===(err.type||"").toLowerCase()&&(cls+=" spelling"),mark.className=cls;var replacements=(err.replacements||[]).join(", "),tipText=(err.message||"")+(replacements?" â†’ "+replacements:"");mark.setAttribute("title",tipText),mark.textContent=text.slice(offset,offset+length),fragment.appendChild(mark),cursor=offset+length})),cursor<text.length&&fragment.appendChild(document.createTextNode(text.slice(cursor)));textEl.firstChild;)textEl.removeChild(textEl.firstChild);textEl.appendChild(fragment)}}},{init:function(cfg){(new WritingPractice).init(cfg)}}}));

//# sourceMappingURL=writing_practice.min.js.map