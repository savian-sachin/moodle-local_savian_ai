{"version":3,"file":"course_content_editor.min.js","sources":["../src/course_content_editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n\n/**\n * Course content editor - View and Edit functionality for generated content\n *\n * @module     local_savian_ai/course_content_editor\n * @copyright  2025 Savian AI\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal', 'core/modal_save_cancel', 'core/modal_events', 'core/ajax', 'core/notification'],\nfunction($, Modal, ModalSaveCancel, ModalEvents, Ajax, Notification) {\n\n    var courseStructure = null;\n\n    return {\n        /**\n         * Initialize the editor\n         * Reads course structure from data attribute\n         */\n        init: function() {\n            // Read structure from data attribute\n            var $dataEl = $('#course-structure-data');\n            if ($dataEl.length === 0) {\n                return; // No structure data available\n            }\n\n            try {\n                // Use attr() to get raw JSON string, not data() which auto-parses\n                var structureData = $dataEl.attr('data-structure');\n                if (!structureData) {\n                    // eslint-disable-next-line no-console\n                    console.error('No course structure data found');\n                    return;\n                }\n\n                // Check if already parsed (jQuery might auto-parse)\n                if (typeof structureData === 'string') {\n                    courseStructure = JSON.parse(structureData);\n                } else {\n                    // Already an object\n                    courseStructure = structureData;\n                }\n            } catch (e) {\n                // eslint-disable-next-line no-console\n                console.error('Failed to parse course structure:', e);\n                return;\n            }\n\n            // View button click handler\n            $(document).on('click', '[data-action=\"view-item\"]', function() {\n                var sectionIdx = $(this).data('section');\n                var itemIdx = $(this).data('item');\n                showViewModal(sectionIdx, itemIdx);\n            });\n\n            // Edit button click handler\n            $(document).on('click', '[data-action=\"edit-item\"]', function() {\n                var sectionIdx = $(this).data('section');\n                var itemIdx = $(this).data('item');\n                showEditModal(sectionIdx, itemIdx);\n            });\n\n            // Expand/collapse all\n            $('#expand-all').on('click', function() {\n                $('.collapse').collapse('show');\n                $(this).blur();\n            });\n\n            $('#collapse-all').on('click', function() {\n                $('.collapse').collapse('hide');\n                $(this).blur();\n            });\n        }\n    };\n\n    /**\n     * Show view modal (read-only)\n     *\n     * @param {number} sectionIdx The section index.\n     * @param {number} itemIdx The item index.\n     */\n    function showViewModal(sectionIdx, itemIdx) {\n        var item = getItem(sectionIdx, itemIdx);\n        if (!item) {\n            return undefined;\n        }\n\n        var content = getItemContent(item);\n        var icon = getContentIcon(item.type);\n\n        // Default title if item doesn't have one\n        var defaultTitles = {\n            'formative': 'Self-Check Questions',\n            'page': 'Content Page',\n            'activity': 'Learning Activity',\n            'discussion': 'Discussion Topic',\n            'quiz': 'Section Quiz',\n            'assignment': 'Assignment'\n        };\n        var displayTitle = item.title || defaultTitles[item.type] || 'Content';\n\n        return Modal.create({\n            title: icon + ' ' + displayTitle,\n            body: '<div class=\"savian-content-preview p-3\">' + content + '</div>',\n            large: true\n        }).then(function(modal) {\n            modal.show();\n            return modal;\n        }).catch(Notification.exception);\n    }\n\n    /**\n     * Show edit modal\n     *\n     * @param {number} sectionIdx The section index.\n     * @param {number} itemIdx The item index.\n     */\n    function showEditModal(sectionIdx, itemIdx) {\n        var item = getItem(sectionIdx, itemIdx);\n        if (!item) {\n            return undefined;\n        }\n\n        var content = getItemContent(item);\n\n        // Default title if item doesn't have one\n        var defaultTitles = {\n            'formative': 'Self-Check Questions',\n            'page': 'Content Page',\n            'activity': 'Learning Activity',\n            'discussion': 'Discussion Topic',\n            'quiz': 'Section Quiz',\n            'assignment': 'Assignment'\n        };\n        var displayTitle = item.title || defaultTitles[item.type] || 'Content';\n\n        var bodyHtml = `\n            <div class=\"form-group\">\n                <label for=\"edit-title\" class=\"font-weight-bold\">Title:</label>\n                <input type=\"text\" class=\"form-control\" id=\"edit-title\" value=\"${escapeHtml(displayTitle)}\">\n            </div>\n            <div class=\"form-group\">\n                <label for=\"edit-content\" class=\"font-weight-bold\">Content:</label>\n                <textarea class=\"form-control\" id=\"edit-content\" rows=\"15\">${escapeHtml(content)}</textarea>\n                <small class=\"form-text text-muted\">You can edit the content before adding to the course.</small>\n            </div>\n        `;\n\n        return ModalSaveCancel.create({\n            title: '<i class=\"fa fa-edit\"></i> Edit: ' + displayTitle,\n            body: bodyHtml,\n            large: true\n        }).then(function(modal) {\n            modal.show();\n\n            // Handle save\n            modal.getRoot().on(ModalEvents.save, function() {\n                saveItemEdits(sectionIdx, itemIdx, modal);\n            });\n\n            return modal;\n        }).catch(Notification.exception);\n    }\n\n    /**\n     * Save edited item to session\n     *\n     * @param {number} sectionIdx The section index.\n     * @param {number} itemIdx The item index.\n     * @param {Object} modal The modal instance.\n     */\n    function saveItemEdits(sectionIdx, itemIdx, modal) {\n        var newTitle = $('#edit-title').val();\n        var newContent = $('#edit-content').val();\n\n        // Update local structure\n        var item = getItem(sectionIdx, itemIdx);\n        if (item) {\n            item.title = newTitle;\n\n            // Update content based on item type\n            if (item.type === 'page') {\n                item.content = newContent;\n            } else if (item.type === 'activity') {\n                item.instructions = newContent;\n            } else if (item.type === 'discussion') {\n                item.prompt = newContent;\n            } else if (item.type === 'formative') {\n                // For formative, store as plain text (questions are in structured format)\n                item.content = newContent;\n            } else if (item.type === 'quiz') {\n                item.description = newContent;\n            } else if (item.type === 'assignment') {\n                item.instructions = newContent;\n            }\n\n            // Save to session via AJAX\n            Ajax.call([{\n                methodname: 'local_savian_ai_save_course_structure',\n                args: {\n                    structure: JSON.stringify(courseStructure)\n                }\n            }])[0].done(function() {\n                // Update preview display\n                updatePreviewItem(sectionIdx, itemIdx, newTitle);\n                Notification.addNotification({\n                    message: 'Changes saved successfully',\n                    type: 'success'\n                });\n                modal.hide();\n            }).fail(function(error) {\n                Notification.exception(error);\n            });\n        }\n    }\n\n    /**\n     * Update preview display after edit\n     *\n     * @param {number} sectionIdx The section index.\n     * @param {number} itemIdx The item index.\n     * @param {string} newTitle The new title to display.\n     */\n    function updatePreviewItem(sectionIdx, itemIdx, newTitle) {\n        var selector = '[data-action=\"view-item\"][data-section=\"' + sectionIdx + '\"][data-item=\"' + itemIdx + '\"]';\n        var $viewBtn = $(selector);\n\n        // Find the title span (sibling of the view button)\n        var $titleSpan = $viewBtn.closest('.list-group-item').find('span').first();\n        $titleSpan.text(newTitle);\n    }\n\n    /**\n     * Get item from structure\n     *\n     * @param {number} sectionIdx The section index.\n     * @param {number} itemIdx The item index.\n     * @returns {Object|null} The item or null.\n     */\n    function getItem(sectionIdx, itemIdx) {\n        if (courseStructure && courseStructure.sections && courseStructure.sections[sectionIdx]) {\n            var section = courseStructure.sections[sectionIdx];\n            if (section.content && section.content[itemIdx]) {\n                return section.content[itemIdx];\n            }\n        }\n        return null;\n    }\n\n    /**\n     * Get item content based on type\n     *\n     * @param {Object} item The content item.\n     * @returns {string} The formatted content.\n     */\n    function getItemContent(item) {\n        switch (item.type) {\n            case 'page':\n                return item.content || '';\n            case 'activity':\n                return item.instructions || item.content || '';\n            case 'discussion':\n                return item.prompt || item.content || '';\n            case 'formative': // ADDIE v2.0\n                return formatFormativeContent(item);\n            case 'quiz':\n                return formatQuizContent(item);\n            case 'assignment':\n                return formatAssignmentContent(item);\n            default:\n                return item.content || '';\n        }\n    }\n\n    /**\n     * Format formative assessment content (ADDIE v2.0)\n     *\n     * @param {Object} formative The formative assessment item.\n     * @returns {string} The formatted HTML.\n     */\n    function formatFormativeContent(formative) {\n        var html = '<div class=\"alert alert-info\">';\n        html += '<h5>‚úì Knowledge Check (Ungraded)</h5>';\n\n        // Show content if available (for edited items)\n        if (formative.content) {\n            html += '<div>' + formative.content + '</div>';\n        }\n\n        // Show structured questions\n        if (formative.questions && formative.questions.length > 0) {\n            html += '<p><strong>Self-assessment questions:</strong></p>';\n            formative.questions.forEach(function(q, idx) {\n                html += '<div class=\"mb-3 p-2 bg-light rounded\">';\n                html += '<p><strong>Q' + (idx + 1) + ':</strong> ' + escapeHtml(q.question) + '</p>';\n                html += '<details><summary class=\"btn btn-sm btn-outline-primary\">Show Answer</summary>';\n                html += '<div class=\"alert alert-success mt-2 mb-0\">' + escapeHtml(q.answer) + '</div>';\n                html += '</details></div>';\n            });\n        }\n\n        html += '</div>';\n        return html;\n    }\n\n    /**\n     * Format quiz content for display\n     *\n     * @param {Object} quiz The quiz item.\n     * @returns {string} The formatted HTML.\n     */\n    function formatQuizContent(quiz) {\n        var html = '<p>' + (quiz.description || '') + '</p>';\n\n        if (quiz.questions && quiz.questions.length > 0) {\n            html += '<h5>Questions (' + quiz.questions.length + '):</h5>';\n            html += '<ol>';\n            quiz.questions.forEach(function(q) {\n                html += '<li><strong>' + escapeHtml(q.question_text || q.text) + '</strong>';\n                if (q.answers && q.answers.length > 0) {\n                    html += '<ul class=\"mt-2\">';\n                    q.answers.forEach(function(a) {\n                        var correct = a.correct || a.fraction === 1 ? ' ‚úì <em>(Correct)</em>' : '';\n                        html += '<li>' + escapeHtml(a.text) + correct + '</li>';\n                    });\n                    html += '</ul>';\n                }\n                html += '</li>';\n            });\n            html += '</ol>';\n        }\n\n        return html;\n    }\n\n    /**\n     * Format assignment content for display\n     *\n     * @param {Object} assignment The assignment item.\n     * @returns {string} The formatted HTML.\n     */\n    function formatAssignmentContent(assignment) {\n        var html = '<div>';\n        html += '<h5>Instructions:</h5>';\n        html += '<p>' + (assignment.instructions || assignment.content || '') + '</p>';\n\n        if (assignment.rubric && assignment.rubric.criteria) {\n            html += '<h5 class=\"mt-3\">üìã Grading Rubric:</h5>';\n            html += '<table class=\"table table-bordered table-sm\">';\n            html += '<thead class=\"thead-light\"><tr><th>Criterion</th>' +\n                    '<th width=\"80\">Points</th><th>Performance Levels</th></tr></thead>';\n            html += '<tbody>';\n            assignment.rubric.criteria.forEach(function(criterion) {\n                html += '<tr>';\n                html += '<td><strong>' + escapeHtml(criterion.name) + '</strong></td>';\n                html += '<td class=\"text-center\">' + (criterion.points || '-') + '</td>';\n                html += '<td>';\n\n                // ADDIE v2.0: Show levels if available\n                if (criterion.levels && criterion.levels.length > 0) {\n                    html += '<ul class=\"list-unstyled mb-0\">';\n                    criterion.levels.forEach(function(level) {\n                        html += '<li class=\"mb-2\">';\n                        html += '<span class=\"badge badge-secondary\">' + level.score + ' pts</span> ';\n                        html += escapeHtml(level.description);\n                        html += '</li>';\n                    });\n                    html += '</ul>';\n                } else {\n                    // Fallback to simple description\n                    html += escapeHtml(criterion.description || '');\n                }\n\n                html += '</td></tr>';\n            });\n            html += '</tbody>';\n            html += '<tfoot><tr><td colspan=\"2\"><strong>Total Points</strong></td><td class=\"text-center\"><strong>' +\n                    (assignment.rubric.total_points || 100) + '</strong></td></tr></tfoot>';\n            html += '</table>';\n        }\n\n        html += '</div>';\n        return html;\n    }\n\n    /**\n     * Get content icon\n     *\n     * @param {string} type The content type.\n     * @returns {string} The icon string.\n     */\n    function getContentIcon(type) {\n        var icons = {\n            'page': 'üìÑ',\n            'activity': 'üéØ',\n            'discussion': 'üí¨',\n            'quiz': '‚ùì',\n            'assignment': 'üìù'\n        };\n        return icons[type] || 'üìå';\n    }\n\n    /**\n     * Escape HTML\n     *\n     * @param {string} text The text to escape.\n     * @returns {string} The escaped HTML string.\n     */\n    function escapeHtml(text) {\n        if (!text) {\n            return '';\n        }\n        var div = document.createElement('div');\n        div.textContent = text;\n        return div.innerHTML;\n    }\n});\n"],"names":["define","$","Modal","ModalSaveCancel","ModalEvents","Ajax","Notification","courseStructure","init","$dataEl","length","structureData","attr","console","error","JSON","parse","e","document","on","sectionIdx","itemIdx","item","getItem","content","getItemContent","icon","type","defaultTitles","displayTitle","title","create","body","large","then","modal","show","catch","exception","showViewModal","this","data","bodyHtml","escapeHtml","getRoot","save","newTitle","val","newContent","instructions","prompt","description","call","methodname","args","structure","stringify","done","closest","find","first","text","updatePreviewItem","addNotification","message","hide","fail","saveItemEdits","showEditModal","collapse","blur","sections","section","formative","html","questions","forEach","q","idx","question","answer","formatFormativeContent","quiz","question_text","answers","a","correct","fraction","formatQuizContent","assignment","rubric","criteria","criterion","name","points","levels","level","score","total_points","formatAssignmentContent","div","createElement","textContent","innerHTML"],"mappings":"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"}