{"version":3,"file":"chat_widget.min.js","sources":["../src/chat_widget.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n\n/**\n * Savian AI Floating Chat Widget\n *\n * @module     local_savian_ai/chat_widget\n * @copyright  2025 Savian AI\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* globals MathJax */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n\n    var ChatWidget = function() {\n        this.isMinimized = true;\n        this.isMaximized = false;\n        this.position = 'bottom-right';\n        this.conversationId = null;\n        this.courseId = null;\n        this.config = {};\n        this.strings = {};\n    };\n\n    ChatWidget.prototype.init = function(config) {\n        this.config = config || {};\n\n        // Extract course ID from body class\n        var bodyClass = $('body').attr('class');\n        var courseMatch = bodyClass.match(/course-(\\d+)/);\n        if (courseMatch) {\n            this.courseId = parseInt(courseMatch[1]);\n        }\n\n        // Load strings\n        var self = this;\n        Str.get_strings([\n            {key: 'openchat', component: 'local_savian_ai'},\n            {key: 'minimize', component: 'local_savian_ai'},\n            {key: 'maximize', component: 'local_savian_ai'},\n            {key: 'newconversation', component: 'local_savian_ai'},\n            {key: 'history', component: 'local_savian_ai'},\n            {key: 'typemessage', component: 'local_savian_ai'},\n            {key: 'send', component: 'local_savian_ai'},\n            {key: 'helpful', component: 'local_savian_ai'},\n            {key: 'nothelpful', component: 'local_savian_ai'}\n        ]).done(function(strings) {\n            self.strings = {\n                openchat: strings[0],\n                minimize: strings[1],\n                maximize: strings[2],\n                newconversation: strings[3],\n                history: strings[4],\n                typemessage: strings[5],\n                send: strings[6],\n                helpful: strings[7],\n                nothelpful: strings[8]\n            };\n\n            self.loadUserSettings();\n\n            // Check if chat is restricted\n            if (self.config.restriction && self.config.restriction.isRestricted) {\n                self.renderRestrictedState();\n            } else {\n                self.render();\n                self.attachEvents();\n\n                // Auto-open if URL param present\n                var urlParams = new URLSearchParams(window.location.search);\n                if (urlParams.get('openchat') === '1') {\n                    self.maximize();\n                }\n            }\n        });\n    };\n\n    ChatWidget.prototype.loadUserSettings = function() {\n        // Load from localStorage\n        var settings = localStorage.getItem('savian_chat_widget_settings');\n        if (settings) {\n            settings = JSON.parse(settings);\n            this.position = settings.position || this.config.defaultPosition || 'bottom-right';\n            this.isMinimized = settings.minimized !== undefined ? settings.minimized : true;\n        } else {\n            this.position = this.config.userPosition || this.config.defaultPosition || 'bottom-right';\n            this.isMinimized = this.config.userMinimized !== undefined ? this.config.userMinimized : true;\n        }\n    };\n\n    ChatWidget.prototype.render = function() {\n        var positionClass = 'savian-widget-' + this.position;\n        var minimizedClass = this.isMinimized ? 'minimized' : 'maximized';\n        var welcomeMsg = this.config.welcomeMessage || 'Hi! I\\'m your AI assistant. Ask me anything about your course materials.';\n\n        var html = `\n            <div id=\"savian-chat-widget\" class=\"savian-chat-widget ${positionClass} ${minimizedClass}\">\n                <!-- Minimized bubble -->\n                <div class=\"savian-chat-bubble\" role=\"button\" tabindex=\"0\" aria-label=\"${this.strings.openchat}\">\n                    <i class=\"fa fa-comments\"></i>\n                    <span class=\"notification-badge hidden\">0</span>\n                </div>\n\n                <!-- Maximized chat window -->\n                <div class=\"savian-chat-window\" role=\"dialog\" aria-label=\"Savian AI Chat\">\n                    <div class=\"savian-chat-header\">\n                        <div class=\"savian-chat-title\">\n                            <i class=\"fa fa-graduation-cap\"></i>\n                            <span>Savian AI Tutor</span>\n                        </div>\n                        <div class=\"savian-chat-actions\">\n                            <button class=\"savian-btn-icon\" id=\"savian-chat-new\" title=\"${this.strings.newconversation}\">\n                                <i class=\"fa fa-plus\"></i>\n                            </button>\n                            ${this.config.canViewHistory ?\n                            '<button class=\"savian-btn-icon\" id=\"savian-chat-history\" title=\"' +\n                            this.strings.history + '\"><i class=\"fa fa-history\"></i></button>' : ''}\n                            <button class=\"savian-btn-icon\" id=\"savian-chat-fullscreen\" title=\"${this.strings.maximize}\">\n                                <i class=\"fa fa-expand\"></i>\n                            </button>\n                            <button class=\"savian-btn-icon\" id=\"savian-chat-minimize\" title=\"${this.strings.minimize}\">\n                                <i class=\"fa fa-minus\"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    <div class=\"savian-chat-body\">\n                        <div class=\"savian-chat-messages\" id=\"savian-chat-messages\">\n                            <!-- Welcome message -->\n                            <div class=\"savian-chat-message assistant\">\n                                <div class=\"savian-message-content\">${welcomeMsg}</div>\n                            </div>\n                        </div>\n\n                        <!-- Document selector - HIDDEN (auto-uses course documents) -->\n                    </div>\n\n                    <div class=\"savian-chat-footer\">\n                        <div class=\"savian-chat-input-wrapper\">\n                            <textarea\n                                id=\"savian-chat-input\"\n                                class=\"savian-chat-input\"\n                                placeholder=\"${this.strings.typemessage}\"\n                                rows=\"1\"\n                                aria-label=\"Chat message input\"\n                            ></textarea>\n                            <button id=\"savian-chat-send\" class=\"savian-btn-send\" aria-label=\"${this.strings.send}\">\n                                <i class=\"fa fa-paper-plane\"></i>\n                            </button>\n                        </div>\n                        <div class=\"savian-chat-status\" id=\"savian-chat-status\"></div>\n                    </div>\n                </div>\n            </div>\n        `;\n\n        $('body').append(html);\n\n        // Load course documents if teacher\n        if (this.config.canManageDocuments && this.courseId) {\n            this.loadCourseDocuments();\n        }\n    };\n\n    /**\n     * Render the restricted state widget with countdown\n     */\n    ChatWidget.prototype.renderRestrictedState = function() {\n        var restriction = this.config.restriction;\n        var resumesAt = restriction.resumesAt ? restriction.resumesAt * 1000 : 0; // Convert to milliseconds\n        var positionClass = 'savian-widget-' + this.position;\n\n        var countdownHtml = '';\n        if (resumesAt > 0) {\n            countdownHtml = `\n                <div class=\"restriction-countdown\">\n                    <p class=\"countdown-label\">Resumes in:</p>\n                    <div class=\"countdown-timer\">\n                        <div class=\"countdown-unit\">\n                            <span class=\"countdown-value\" id=\"countdown-hours\">--</span>\n                            <span class=\"countdown-text\">hrs</span>\n                        </div>\n                        <div class=\"countdown-unit\">\n                            <span class=\"countdown-value\" id=\"countdown-minutes\">--</span>\n                            <span class=\"countdown-text\">min</span>\n                        </div>\n                        <div class=\"countdown-unit\">\n                            <span class=\"countdown-value\" id=\"countdown-seconds\">--</span>\n                            <span class=\"countdown-text\">sec</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        } else {\n            countdownHtml = '<p class=\"restriction-no-end\">Check back later</p>';\n        }\n\n        var html = `\n            <div id=\"savian-chat-widget\" class=\"savian-chat-widget ${positionClass} restricted\">\n                <!-- Restricted bubble with overlay -->\n                <div class=\"savian-chat-bubble restricted\" role=\"button\" tabindex=\"0\" aria-label=\"Chat unavailable\">\n                    <i class=\"fa fa-comments\"></i>\n                    <span class=\"restriction-icon-overlay\"><i class=\"fa fa-ban\"></i></span>\n                </div>\n\n                <!-- Restricted message window -->\n                <div class=\"savian-chat-window restricted-window\" role=\"dialog\" aria-label=\"Chat Restricted\">\n                    <div class=\"savian-chat-header restricted-header\">\n                        <div class=\"savian-chat-title\">\n                            <i class=\"fa fa-clock-o\"></i>\n                            <span>Chat Temporarily Unavailable</span>\n                        </div>\n                        <div class=\"savian-chat-actions\">\n                            <button class=\"savian-btn-icon\" id=\"savian-chat-minimize\" title=\"Minimize\">\n                                <i class=\"fa fa-minus\"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    <div class=\"savian-chat-body restriction-body\">\n                        <div class=\"restriction-icon-large\">\n                            <i class=\"fa fa-graduation-cap fa-4x\"></i>\n                        </div>\n                        <p class=\"restriction-message\">${restriction.message}</p>\n                        ${countdownHtml}\n                    </div>\n                </div>\n            </div>\n        `;\n\n        $('body').append(html);\n\n        // Attach events for restricted state\n        this.attachRestrictedEvents();\n\n        // Start countdown if there's an end time\n        if (resumesAt > 0) {\n            this.startCountdown(resumesAt);\n        }\n    };\n\n    /**\n     * Attach events for restricted state widget\n     */\n    ChatWidget.prototype.attachRestrictedEvents = function() {\n        // Toggle on bubble click\n        $(document).on('click', '#savian-chat-widget.restricted .savian-chat-bubble', function() {\n            $('#savian-chat-widget').toggleClass('minimized').toggleClass('maximized');\n        });\n\n        // Minimize button\n        $(document).on('click', '#savian-chat-widget.restricted #savian-chat-minimize', function(e) {\n            e.stopPropagation();\n            $('#savian-chat-widget').addClass('minimized').removeClass('maximized');\n        });\n    };\n\n    /**\n     * Start countdown timer\n     * @param {number} targetTime - The target timestamp in milliseconds\n     */\n    ChatWidget.prototype.startCountdown = function(targetTime) {\n        var updateCountdown = function() {\n            var now = Date.now();\n            var remaining = targetTime - now;\n\n            if (remaining <= 0) {\n                // Restriction ended - reload page to get fresh state\n                window.location.reload();\n                return;\n            }\n\n            var hours = Math.floor(remaining / (1000 * 60 * 60));\n            var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));\n            var seconds = Math.floor((remaining % (1000 * 60)) / 1000);\n\n            $('#countdown-hours').text(hours.toString().padStart(2, '0'));\n            $('#countdown-minutes').text(minutes.toString().padStart(2, '0'));\n            $('#countdown-seconds').text(seconds.toString().padStart(2, '0'));\n        };\n\n        // Initial update\n        updateCountdown();\n\n        // Update every second\n        setInterval(updateCountdown, 1000);\n    };\n\n    ChatWidget.prototype.renderDocumentSelector = function() {\n        return `\n            <div class=\"savian-document-selector\" id=\"savian-document-selector\">\n                <label>\n                    <i class=\"fa fa-file-text\"></i>\n                    Select documents for context\n                </label>\n                <select multiple class=\"form-control form-control-sm\" id=\"savian-doc-select\" size=\"3\">\n                    <option value=\"\">Loading...</option>\n                </select>\n            </div>\n        `;\n    };\n\n    ChatWidget.prototype.loadCourseDocuments = function() {\n        Ajax.call([{\n            methodname: 'local_savian_ai_get_course_documents',\n            args: {courseid: this.courseId}\n        }])[0].done(function(response) {\n            if (response.success && response.documents && response.documents.length > 0) {\n                var html = '<option value=\"\">Select documents (optional)</option>';\n                response.documents.forEach(function(doc) {\n                    html += '<option value=\"' + doc.id + '\">' + doc.title + '</option>';\n                });\n                $('#savian-doc-select').html(html);\n            } else {\n                $('#savian-doc-select').html('<option value=\"\">No documents available</option>');\n            }\n        }).fail(function(error) {\n            // eslint-disable-next-line no-console\n            console.error('Failed to load documents:', error);\n            $('#savian-doc-select').html('<option value=\"\">Failed to load documents</option>');\n        });\n    };\n\n    ChatWidget.prototype.attachEvents = function() {\n        var self = this;\n\n        // Toggle minimize/maximize on bubble click\n        $(document).on('click', '#savian-chat-widget .savian-chat-bubble', function() {\n            self.maximize();\n        });\n\n        // Also handle keyboard activation\n        $(document).on('keydown', '#savian-chat-widget .savian-chat-bubble', function(e) {\n            if (e.key === 'Enter' || e.key === ' ') {\n                e.preventDefault();\n                self.maximize();\n            }\n        });\n\n        // Minimize button\n        $(document).on('click', '#savian-chat-minimize', function() {\n            self.minimize();\n        });\n\n        // Fullscreen/maximize button\n        $(document).on('click', '#savian-chat-fullscreen', function() {\n            self.toggleFullscreen();\n        });\n\n        // ESC key to exit fullscreen\n        $(document).on('keydown', function(e) {\n            if (e.key === 'Escape' && self.isMaximized) {\n                self.toggleFullscreen();\n            }\n        });\n\n        // Send message button\n        $(document).on('click', '#savian-chat-send', function() {\n            self.sendMessage();\n        });\n\n        // Enter to send (Shift+Enter for new line)\n        $(document).on('keydown', '#savian-chat-input', function(e) {\n            if (e.key === 'Enter' && !e.shiftKey) {\n                e.preventDefault();\n                self.sendMessage();\n            }\n        });\n\n        // Auto-resize textarea\n        $(document).on('input', '#savian-chat-input', function() {\n            this.style.height = 'auto';\n            this.style.height = Math.min(this.scrollHeight, 120) + 'px';\n        });\n\n        // New conversation\n        $(document).on('click', '#savian-chat-new', function() {\n            self.startNewConversation();\n        });\n\n        // View history\n        $(document).on('click', '#savian-chat-history', function() {\n            self.showHistory();\n        });\n\n        // Feedback buttons (delegated event for dynamic content)\n        $(document).on('click', '.savian-btn-feedback', function() {\n            var $btn = $(this);\n            var messageid = $btn.closest('.savian-message-feedback').data('message-id');\n            var feedback = parseInt($btn.data('feedback'));\n            self.submitFeedback(messageid, feedback, $btn);\n        });\n    };\n\n    ChatWidget.prototype.maximize = function() {\n        this.isMinimized = false;\n        $('#savian-chat-widget').removeClass('minimized').addClass('maximized');\n        $('#savian-chat-input').focus();\n        this.saveWidgetState();\n\n        // Load conversation if exists\n        if (this.conversationId) {\n            this.loadConversation(this.conversationId);\n        }\n    };\n\n    ChatWidget.prototype.minimize = function() {\n        this.isMinimized = true;\n        this.isMaximized = false;\n        $('#savian-chat-widget').removeClass('maximized fullscreen').addClass('minimized');\n        $('#savian-chat-backdrop').remove();\n        this.updateFullscreenButton();\n        this.saveWidgetState();\n    };\n\n    ChatWidget.prototype.toggleFullscreen = function() {\n        this.isMaximized = !this.isMaximized;\n\n        if (this.isMaximized) {\n            // Enter fullscreen mode\n            $('#savian-chat-widget').addClass('fullscreen');\n            $('#savian-chat-fullscreen i').removeClass('fa-expand').addClass('fa-compress');\n            $('#savian-chat-fullscreen').attr('title', 'Exit fullscreen');\n\n            // Add backdrop\n            if ($('#savian-chat-backdrop').length === 0) {\n                $('body').append('<div id=\"savian-chat-backdrop\" class=\"savian-chat-backdrop\"></div>');\n            }\n\n            // Focus input\n            $('#savian-chat-input').focus();\n        } else {\n            // Exit fullscreen mode\n            $('#savian-chat-widget').removeClass('fullscreen');\n            $('#savian-chat-fullscreen i').removeClass('fa-compress').addClass('fa-expand');\n            $('#savian-chat-fullscreen').attr('title', this.strings.maximize);\n            $('#savian-chat-backdrop').remove();\n        }\n\n        this.scrollToBottom();\n    };\n\n    ChatWidget.prototype.updateFullscreenButton = function() {\n        if (this.isMaximized) {\n            $('#savian-chat-fullscreen i').removeClass('fa-expand').addClass('fa-compress');\n        } else {\n            $('#savian-chat-fullscreen i').removeClass('fa-compress').addClass('fa-expand');\n        }\n    };\n\n    ChatWidget.prototype.sendMessage = function() {\n        var message = $('#savian-chat-input').val().trim();\n        if (!message) {\n            return;\n        }\n\n        // Disable input\n        $('#savian-chat-input, #savian-chat-send').prop('disabled', true);\n\n        // Add user message to UI\n        this.addMessageToUI('user', message);\n\n        // Clear input\n        $('#savian-chat-input').val('').css('height', 'auto');\n\n        // Show typing indicator\n        this.showTypingIndicator();\n\n        // Auto-include course documents (no manual selection)\n        var documentIds = [];\n\n        // Send to backend\n        var self = this;\n        Ajax.call([{\n            methodname: 'local_savian_ai_send_chat_message',\n            args: {\n                message: message,\n                conversationid: this.conversationId || 0,\n                courseid: this.courseId || 0,\n                documentids: documentIds\n            }\n        }])[0].done(function(response) {\n            self.hideTypingIndicator();\n\n            if (response.success) {\n                // Update conversation ID\n                self.conversationId = response.data.conversation_id;\n\n                // Add assistant message\n                self.addMessageToUI('assistant', response.data.assistant_message.formatted_content, {\n                    sources: response.data.assistant_message.sources,\n                    messageId: response.data.assistant_message.id\n                });\n            } else {\n                Notification.addNotification({\n                    message: response.error || 'Failed to send message',\n                    type: 'error'\n                });\n            }\n\n            // Re-enable input\n            $('#savian-chat-input, #savian-chat-send').prop('disabled', false);\n            $('#savian-chat-input').focus();\n\n        }).fail(function(error) {\n            self.hideTypingIndicator();\n            Notification.exception(error);\n            $('#savian-chat-input, #savian-chat-send').prop('disabled', false);\n        });\n    };\n\n    ChatWidget.prototype.addMessageToUI = function(role, content, options) {\n        options = options || {};\n\n        // Parse sources if it's a JSON string\n        var sources = options.sources;\n        if (typeof sources === 'string') {\n            try {\n                sources = JSON.parse(sources);\n            } catch (e) {\n                sources = [];\n            }\n        }\n\n        var messageHtml = `\n            <div class=\"savian-chat-message ${role}\" data-message-id=\"${options.messageId || ''}\">\n                <div class=\"savian-message-content\">\n                    ${content}\n                </div>\n                ${sources && sources.length > 0 ? this.renderSources(sources) : ''}\n                ${role === 'assistant' && options.messageId && this.config.enableFeedback ?\n                    this.renderFeedback(options.messageId) : ''}\n                <div class=\"savian-message-time\">${this.formatTime(new Date())}</div>\n            </div>\n        `;\n\n        $('#savian-chat-messages').append(messageHtml);\n\n        // Apply syntax highlighting and LaTeX rendering\n        this.enhanceMessage($('#savian-chat-messages .savian-chat-message').last());\n\n        // Scroll to bottom\n        this.scrollToBottom();\n    };\n\n    ChatWidget.prototype.renderSources = function(sources) {\n        if (!sources || !Array.isArray(sources) || sources.length === 0) {\n            return '';\n        }\n\n        var sourcesHtml = '<div class=\"savian-message-sources\"><i class=\"fa fa-book\"></i> Sources: ';\n        sources.forEach(function(source, idx) {\n            var title = '';\n            if (typeof source === 'object' && source !== null) {\n                title = source.title || source.document_title || 'Document ' + (idx + 1);\n            } else if (typeof source === 'string') {\n                title = source;\n            } else {\n                title = 'Document ' + (idx + 1);\n            }\n            sourcesHtml += `<span class=\"savian-source-badge\">${title}</span>`;\n        });\n        sourcesHtml += '</div>';\n\n        return sourcesHtml;\n    };\n\n    ChatWidget.prototype.renderFeedback = function(messageId) {\n        return `\n            <div class=\"savian-message-feedback\" data-message-id=\"${messageId}\">\n                <button class=\"savian-btn-feedback\" data-feedback=\"1\" aria-label=\"${this.strings.helpful}\">\n                    <i class=\"fa fa-thumbs-up\"></i>\n                </button>\n                <button class=\"savian-btn-feedback\" data-feedback=\"-1\" aria-label=\"${this.strings.nothelpful}\">\n                    <i class=\"fa fa-thumbs-down\"></i>\n                </button>\n            </div>\n        `;\n    };\n\n    ChatWidget.prototype.enhanceMessage = function($messageEl) {\n        // Apply code syntax highlighting if highlight.js is available\n        $messageEl.find('pre code').each(function() {\n            if (window.hljs) {\n                window.hljs.highlightElement(this);\n            }\n        });\n\n        // Render LaTeX with MathJax if available\n        if (window.MathJax && window.MathJax.typesetPromise) {\n            MathJax.typesetPromise([$messageEl[0]]).catch(function(err) {\n                // eslint-disable-next-line no-console\n                console.error('MathJax rendering error:', err);\n            });\n        }\n    };\n\n    ChatWidget.prototype.showTypingIndicator = function() {\n        var typingHtml = `\n            <div class=\"savian-chat-message assistant savian-typing-indicator\" id=\"savian-typing-indicator\">\n                <div class=\"savian-message-content\">\n                    <span class=\"savian-typing-dot\"></span>\n                    <span class=\"savian-typing-dot\"></span>\n                    <span class=\"savian-typing-dot\"></span>\n                </div>\n            </div>\n        `;\n        $('#savian-chat-messages').append(typingHtml);\n        this.scrollToBottom();\n    };\n\n    ChatWidget.prototype.hideTypingIndicator = function() {\n        $('#savian-typing-indicator').remove();\n    };\n\n    ChatWidget.prototype.scrollToBottom = function() {\n        var $messages = $('#savian-chat-messages');\n        $messages.scrollTop($messages[0].scrollHeight);\n    };\n\n    ChatWidget.prototype.loadConversation = function(conversationId) {\n        var self = this;\n\n        Ajax.call([{\n            methodname: 'local_savian_ai_get_conversation',\n            args: {conversationid: conversationId}\n        }])[0].done(function(response) {\n            if (response.success && response.data.messages) {\n                // Clear messages\n                $('#savian-chat-messages').empty();\n\n                // Add messages\n                response.data.messages.forEach(function(msg) {\n                    self.addMessageToUI(msg.role, msg.formatted_content, {\n                        sources: msg.sources,\n                        messageId: msg.id\n                    });\n                });\n            }\n        }).fail(function(error) {\n            // eslint-disable-next-line no-console\n            console.error('Failed to load conversation:', error);\n        });\n    };\n\n    ChatWidget.prototype.startNewConversation = function() {\n        this.conversationId = null;\n        $('#savian-chat-messages').empty();\n\n        var welcomeMsg = this.config.welcomeMessage || 'Hi! I\\'m your AI assistant. Ask me anything about your course materials.';\n        this.addMessageToUI('assistant', welcomeMsg);\n    };\n\n    ChatWidget.prototype.showHistory = function() {\n        // Open history in new window\n        if (this.config.canViewHistory && this.courseId) {\n            var url = M.cfg.wwwroot + '/local/savian_ai/chat_history.php?courseid=' + this.courseId;\n            window.open(url, '_blank');\n        }\n    };\n\n    ChatWidget.prototype.submitFeedback = function(messageId, feedback, $btn) {\n        Ajax.call([{\n            methodname: 'local_savian_ai_submit_feedback',\n            args: {\n                messageid: messageId,\n                feedback: feedback,\n                comment: ''\n            }\n        }])[0].done(function(response) {\n            if (response.success) {\n                // Mark button as active\n                $btn.addClass('active').siblings().removeClass('active');\n            }\n        }).fail(function(error) {\n            // eslint-disable-next-line no-console\n            console.error('Failed to submit feedback:', error);\n        });\n    };\n\n    ChatWidget.prototype.saveWidgetState = function() {\n        var settings = {\n            position: this.position,\n            minimized: this.isMinimized\n        };\n\n        localStorage.setItem('savian_chat_widget_settings', JSON.stringify(settings));\n\n        // Sync to DB\n        Ajax.call([{\n            methodname: 'local_savian_ai_save_widget_state',\n            args: {\n                position: this.position,\n                minimized: this.isMinimized ? 1 : 0\n            }\n        }])[0].fail(function(error) {\n            // eslint-disable-next-line no-console\n            console.error('Failed to save widget state:', error);\n        });\n    };\n\n    ChatWidget.prototype.formatTime = function(date) {\n        return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});\n    };\n\n    return {\n        init: function(config) {\n            var widget = new ChatWidget();\n            widget.init(config);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ChatWidget","isMinimized","isMaximized","position","conversationId","courseId","config","strings","prototype","init","courseMatch","attr","match","parseInt","self","this","get_strings","key","component","done","openchat","minimize","maximize","newconversation","history","typemessage","send","helpful","nothelpful","loadUserSettings","restriction","isRestricted","renderRestrictedState","render","attachEvents","URLSearchParams","window","location","search","get","settings","localStorage","getItem","JSON","parse","defaultPosition","undefined","minimized","userPosition","userMinimized","positionClass","minimizedClass","welcomeMsg","welcomeMessage","html","canViewHistory","append","canManageDocuments","loadCourseDocuments","resumesAt","countdownHtml","message","attachRestrictedEvents","startCountdown","document","on","toggleClass","e","stopPropagation","addClass","removeClass","targetTime","updateCountdown","now","Date","remaining","reload","hours","Math","floor","minutes","seconds","text","toString","padStart","setInterval","renderDocumentSelector","call","methodname","args","courseid","response","success","documents","length","forEach","doc","id","title","fail","error","console","preventDefault","toggleFullscreen","sendMessage","shiftKey","style","height","min","scrollHeight","startNewConversation","showHistory","$btn","messageid","closest","data","feedback","submitFeedback","focus","saveWidgetState","loadConversation","remove","updateFullscreenButton","scrollToBottom","val","trim","prop","addMessageToUI","css","showTypingIndicator","conversationid","documentids","hideTypingIndicator","conversation_id","assistant_message","formatted_content","sources","messageId","addNotification","type","exception","role","content","options","messageHtml","renderSources","enableFeedback","renderFeedback","formatTime","enhanceMessage","last","Array","isArray","sourcesHtml","source","idx","document_title","$messageEl","find","each","hljs","highlightElement","MathJax","typesetPromise","catch","err","$messages","scrollTop","messages","empty","msg","url","M","cfg","wwwroot","open","comment","siblings","setItem","stringify","date","toLocaleTimeString","hour","minute"],"mappings":"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"}